image: git-registry.hack-hro.de:443/stadtgestalten/stadtgestalten/build:latest

before_script:
    # Do not use the 'build/' subdirectory, since this would get cleanup up during 'dist-deb'.
    # This directory needs to be listed in debian/source/options in 'extend-diff-ignore'.
    - virtualenv -p python3 --system-site-packages "$CI_PROJECT_DIR/gitlab-ci-build-venv"
    - source "$CI_PROJECT_DIR/gitlab-ci-build-venv/bin/activate"
    - pip install --upgrade pip
    - pip install --upgrade -r requirements.txt

make_test:
    stage: test
    script:
        # stadt.settings is required for the tests
        - make app_local_settings
        - make lint
        - make test

# The latest built deb package is available under the following URL:
#   https://git.hack-hro.de/stadtgestalten/stadtgestalten/builds/artifacts/master/raw/build/debian/export/stadtgestalten.deb?job=deb-package
make_deb_package:
    stage: deploy
    only:
        - triggers
        - schedules
        - merge_requests
        - web
    script:
        - make dist-deb DEBIAN_BUILDPACKAGE_COMMAND="dpkg-buildpackage --no-sign"
    artifacts:
        paths:
            - build/debian
        expire_in: 1w

make_deb_package_release:
    stage: deploy
    only:
        - tags
        - web
    script:
        - make dist-deb DEBIAN_BUILDPACKAGE_COMMAND="dpkg-buildpackage --no-sign"
    artifacts:
        paths:
            - build/debian
        expire_in: 1000 yrs
